<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:tx="http://www.springframework.org/schema/tx"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd
		http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd">

	<!-- Must be placed after the EntityManagerFactory bean definition to work -->
	<context:spring-configured />

	<!-- User management -->

	<bean id="userActivationRequester"
		class="com.gb1.healthcheck.domain.users.EmailUserActivationRequester">
		<property name="tokenFactory" ref="tokenFactory" />
		<property name="emailBuilder" ref="userActivationEmailBuilder" />
		<property name="emailSender" ref="mailSender" />
	</bean>

	<bean id="userActivationEmailBuilder"
		class="com.gb1.healthcheck.domain.users.VelocityUserActivationRequestEmailBuilder">
		<property name="subject" value="[HealthCheck] Account activation" />
		<property name="fromAddress" value="admin@gb1.com" />
		<property name="activationFormUrl"
			value="http://localhost:8080/healthcheck/public/register/challenge.go" />
		<property name="mailSender" ref="mailSender" />
		<property name="velocityEngine" ref="velocityEngine" />
		<property name="templateLocation" value="com/gb1/healthcheck/domain/users/lostPasswordEmail.vm" />
	</bean>

	<bean id="userCreationValidator"
		class="com.gb1.healthcheck.domain.users.FullUserCreationValidator">
		<property name="userRepository" ref="userRepository" />
	</bean>
	<bean id="userUpdateValidator" class="com.gb1.healthcheck.domain.users.FullUserUpdateValidator">
		<property name="userRepository" ref="userRepository" />
	</bean>

	<bean id="lostPasswordSender"
		class="com.gb1.healthcheck.domain.users.EmailLostPasswordReminder">
		<property name="lostPasswordEmailBuilder" ref="lostPasswordEmailBuilder" />
		<property name="mailSender" ref="mailSender" />
	</bean>

	<bean id="lostPasswordEmailBuilder" class="com.gb1.healthcheck.domain.users.VelocityLostPasswordEmailBuilder">
		<property name="fromAddress" value="admin@gb1.com" />
		<property name="subject" value="[HealthCheck] Password" />
		<property name="mailSender" ref="mailSender" />
		<property name="velocityEngine" ref="velocityEngine" />
		<property name="templateLocation" value="com/gb1/healthcheck/domain/users/lostPasswordEmail.vm" />
	</bean>

	<bean id="velocityEngine" class="org.springframework.ui.velocity.VelocityEngineFactoryBean">
		<property name="velocityProperties">
			<value>
				resource.loader=class
				class.resource.loader.class=org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader
			</value>
		</property>
	</bean>

	<bean id="tokenFactory" class="com.gb1.commons.tokens.UuidTokenFactory" />

	<!-- Food management -->

	<bean id="simpleFoodCreationValidator" class="com.gb1.healthcheck.domain.foods.FullSimpleFoodCreationValidator">
		<property name="foodRepository" ref="foodRepository" />
	</bean>
	<bean id="simpleFoodUpdateValidator" class="com.gb1.healthcheck.domain.foods.FullSimpleFoodUpdateValidator">
		<property name="foodRepository" ref="foodRepository" />
	</bean>

	<bean id="complexFoodCreationValidator" class="com.gb1.healthcheck.domain.foods.FullComplexFoodCreationValidator">
		<property name="foodRepository" ref="foodRepository" />
	</bean>
	<bean id="complexFoodUpdateValidator" class="com.gb1.healthcheck.domain.foods.FullComplexFoodUpdateValidator">
		<property name="foodRepository" ref="foodRepository" />
	</bean>
	<bean id="complexFoodCreationPropertyProviderAdapter" class="com.gb1.healthcheck.services.foods.support.ComplexFoodCreationPropertyProviderAdapter" scope="prototype">
		<property name="foodRepository" ref="foodRepository" />
	</bean>
	<bean id="complexFoodUpdatePropertyProviderAdapter" class="com.gb1.healthcheck.services.foods.support.ComplexFoodUpdatePropertyProviderAdapter" scope="prototype">
		<property name="foodRepository" ref="foodRepository" />
	</bean>

	<bean id="mealCreationValidator" class="com.gb1.healthcheck.domain.meals.FullMealCreationValidator">
		<property name="mealRepository" ref="mealRepository" />
	</bean>
	<bean id="mealUpdateValidator" class="com.gb1.healthcheck.domain.meals.FullMealUpdateValidator">
		<property name="mealRepository" ref="mealRepository" />
	</bean>
	<bean id="mealCreationPropertyProviderAdapter" class="com.gb1.healthcheck.services.meals.support.MealCreationPropertyProviderAdapter" scope="prototype">
		<property name="foodRepository" ref="foodRepository" />
		<property name="userRepository" ref="userRepository" />
	</bean>
	<bean id="mealUpdatePropertyProviderAdapter" class="com.gb1.healthcheck.services.meals.support.MealUpdatePropertyProviderAdapter" scope="prototype">
		<property name="foodRepository" ref="foodRepository" />
	</bean>

	<!-- Repositories -->
	<bean id="userRepository" class="com.gb1.healthcheck.domain.users.JpaUserRepository" />
	<bean id="foodRepository" class="com.gb1.healthcheck.domain.foods.JpaFoodRepository" />
	<bean id="mealRepository" class="com.gb1.healthcheck.domain.meals.JpaMealRepository" />
	<bean id="patientFileRepository" class="com.gb1.healthcheck.domain.metrics.JpaPatientFileRepository" />

</beans>
